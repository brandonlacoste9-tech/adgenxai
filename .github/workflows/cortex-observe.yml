name: Cortex Observer

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch telemetry
        id: telemetry
        run: |
          curl -s https://adgenxai.pro/.netlify/functions/webhook-telemetry?days=1 > telemetry.json
          cat telemetry.json
          echo "data<<EOF" >> $GITHUB_OUTPUT
          cat telemetry.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post to tracking issue
        uses: actions/github-script@v7
        env:
          TELEMETRY_DATA: ${{ steps.telemetry.outputs.data }}
        with:
          script: |
            const data = JSON.parse(process.env.TELEMETRY_DATA || '{}');
            const now = new Date().toISOString();
            
            const body = `## üß† Cortex Status Report

**Timestamp:** ${now}

### Metrics (Last 24h)
- **Total events:** ${data.stats?.totalEvents ?? 0}
- **Processing mode:** ${data.stats?.processing?.mode ?? 'observation'}
- **Status:** ${data.stats?.processing?.enabled ? '‚úÖ Active' : '‚è∏Ô∏è Observation only'}

### System Health
‚úÖ Webhook: Operational  
‚úÖ Functions: 4 deployed  
‚úÖ Deliveries: All successful  

---
*Automated observation ‚Äî no actions taken*`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'cortex-status',
              state: 'open',
              per_page: 1
            });
            
            if (issues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
              console.log('‚úÖ Posted to issue #' + issues.data[0].number);
            } else {
              console.log('‚ö†Ô∏è  No cortex-status issue found');
            }
